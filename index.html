<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- APK-Compatible Viewport Settings -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ULTIMATE PASS & PANIC</title>
    <meta name="description" content="The ultimate party game of truth, dare, and panic! Play with 2-30 players, multiple modes, and endless challenges.">
    <meta name="theme-color" content="#ff0033">
    
    <!-- APK compatibility -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Prevent rotation -->
    <meta name="screen-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    
    <!-- Manifest for APK -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚠️</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== ANDROID APK FIXES ========== */
        /* Prevent body scrolling and rotation issues */
        html, body {
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }
        
        /* Force portrait orientation */
        @media screen and (min-width: 320px) and (max-width: 767px) and (orientation: landscape) {
            html {
                transform: rotate(-90deg);
                transform-origin: left top;
                width: 100vh;
                overflow-x: hidden;
                position: absolute;
                top: 100%;
                left: 0;
            }
        }
        
        /* Fix for 100vh on mobile */
        :root {
            --vh: 1vh;
            --safe-top: max(env(safe-area-inset-top), 15px);
            --safe-bottom: max(env(safe-area-inset-bottom), 15px);
            --safe-left: max(env(safe-area-inset-left), 15px);
            --safe-right: max(env(safe-area-inset-right), 15px);
        }
        
        /* APK-specific fixes */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* Ensure buttons work well on mobile */
        button, input, .btn, .mode-card, .player-tag {
            touch-action: manipulation;
            min-height: 44px !important;
            min-width: 44px !important;
        }
        
        /* Prevent zoom on input focus for Android */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        /* Keyboard handling */
        body.keyboard-open .bottom-nav,
        body.keyboard-open .game-header,
        body.keyboard-open .emergency-stop,
        body.keyboard-open .volume-control {
            display: none !important;
        }
        
        body.keyboard-open .screen {
            padding-bottom: 20px !important;
        }
        
        /* Fix for input focus on Android */
        input:focus, textarea:focus {
            transform: translate3d(0, 0, 0);
            -webkit-transform: translate3d(0, 0, 0);
        }
        
        /* ========== EXISTING STYLES ========== */
        :root {
            --primary-red: #ff0033;
            --primary-green: #00ff88;
            --primary-blue: #0088ff;
            --primary-purple: #aa00ff;
            --primary-yellow: #ffcc00;
            --dark-bg: #0a0a0a;
            --darker-bg: #050505;
            --light-text: #ffffff;
            --glow-red: 0 0 20px rgba(255, 0, 51, 0.7);
            --glow-green: 0 0 20px rgba(0, 255, 136, 0.7);
            --glow-blue: 0 0 20px rgba(0, 136, 255, 0.7);
            --glow-purple: 0 0 20px rgba(170, 0, 255, 0.7);
            --glow-yellow: 0 0 20px rgba(255, 204, 0, 0.7);
        }

        /* Theme Variables */
        .theme-neon {
            --primary-red: #ff0033;
            --primary-green: #00ff88;
            --primary-blue: #0088ff;
            --primary-purple: #aa00ff;
            --primary-yellow: #ffcc00;
        }

        .theme-retro {
            --primary-red: #ff4757;
            --primary-green: #2ed573;
            --primary-blue: #3742fa;
            --primary-purple: #9c88ff;
            --primary-yellow: #ff9f43;
        }

        .theme-dark-party {
            --primary-red: #ff3838;
            --primary-green: #32ff7e;
            --primary-blue: #18dcff;
            --primary-purple: #c56cf0;
            --primary-yellow: #ffaf40;
            --dark-bg: #1a1a2e;
            --darker-bg: #16213e;
        }

        .theme-minimal {
            --primary-red: #ff6b6b;
            --primary-green: #51cf66;
            --primary-blue: #339af0;
            --primary-purple: #cc5de8;
            --primary-yellow: #ffd43b;
            --dark-bg: #f8f9fa;
            --darker-bg: #e9ecef;
            --light-text: #212529;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--dark-bg);
            color: var(--light-text);
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
            overflow-x: hidden;
            position: relative;
            padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Emergency Stop */
        .emergency-stop {
            position: fixed;
            top: calc(var(--safe-top) + 10px);
            right: calc(var(--safe-right) + 10px);
            z-index: 10000;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #ff9f43;
            color: #000;
            text-align: center;
            padding: 8px;
            z-index: 10001;
            display: none;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Volume Control */
        .volume-control {
            position: fixed;
            top: calc(var(--safe-top) + 10px);
            right: calc(var(--safe-right) + 70px);
            z-index: 1001;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .volume-slider {
            width: 60px;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-red);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 51, 0.5);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-red);
            cursor: pointer;
            border: none;
        }

        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: calc(var(--safe-bottom) + 70px);
            right: calc(var(--safe-right) + 10px);
            background: rgba(255, 0, 51, 0.9);
            color: white;
            padding: 12px;
            border-radius: 12px;
            z-index: 10000;
            display: none;
            backdrop-filter: blur(10px);
            max-width: 280px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .install-prompt button {
            background: white;
            color: #ff0033;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 51, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(0, 136, 255, 0.1) 0%, transparent 50%),
                linear-gradient(to bottom, var(--darker-bg), var(--dark-bg));
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            width: 100%;
            height: 100%;
        }

        /* Screen Transitions */
        .screen {
            display: none;
            position: relative;
            min-height: calc(100vh - var(--safe-top) - var(--safe-bottom));
            min-height: calc((var(--vh, 1vh) * 100) - var(--safe-top) - var(--safe-bottom));
            padding: 15px;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        /* Game Header */
        .game-header {
            position: fixed;
            top: var(--safe-top);
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            z-index: 1000;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-title h1 {
            font-size: 1.1rem;
            background: linear-gradient(45deg, var(--primary-red), var(--primary-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .game-stats {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        /* Home Screen */
        .logo {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--primary-red), var(--primary-purple), var(--primary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: logo-glow 3s infinite alternate;
        }

        .tagline {
            font-size: 1rem;
            margin-bottom: 20px;
            color: #aaa;
            max-width: 100%;
            line-height: 1.4;
            padding: 0 10px;
        }

        /* Mode Selection Screen */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-width: 100%;
            width: 100%;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            touch-action: manipulation;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-blue);
            box-shadow: var(--glow-blue);
        }

        .mode-card.selected {
            border-color: var(--primary-green);
            box-shadow: var(--glow-green);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .mode-tag {
            display: inline-block;
            background: rgba(255, 0, 51, 0.2);
            color: var(--primary-red);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 8px 0;
        }

        /* Setup Screen */
        .player-setup {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            max-width: 100%;
            width: 100%;
        }

        .player-input {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .player-input input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            min-height: 44px;
            font-size: 16px;
        }

        .player-input button {
            padding: 0 15px;
            background: var(--primary-green);
            border: none;
            border-radius: 8px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            min-height: 44px;
            min-width: 70px;
        }

        /* Player List */
        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .player-tag {
            background: rgba(0, 136, 255, 0.2);
            padding: 10px 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid var(--primary-blue);
            font-size: 0.85rem;
            position: relative;
            cursor: pointer;
            min-height: 44px;
            max-width: 100%;
            overflow: hidden;
        }

        .player-tag:hover {
            background: rgba(0, 136, 255, 0.3);
        }

        .player-tag .remove-player {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        /* Panic Screen */
        .panic-timer {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 15px 0;
            color: var(--primary-red);
            text-shadow: var(--glow-red);
            animation: pulse 0.5s infinite alternate;
            font-family: 'Courier New', monospace;
        }

        .timer-pressure {
            font-size: 1rem;
            margin-top: 8px;
            padding: 4px 12px;
            border-radius: 12px;
            background: rgba(255, 0, 51, 0.2);
            display: inline-block;
        }

        .current-player-display {
            font-size: 1.5rem;
            margin: 15px 0;
            padding: 12px 20px;
            background: rgba(255, 0, 51, 0.2);
            border-radius: 15px;
            border: 2px solid var(--primary-red);
            animation: current-player-glow 2s infinite alternate;
        }

        /* Group Challenge */
        .group-challenge {
            background: rgba(170, 0, 255, 0.1);
            border: 2px solid var(--primary-purple);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-width: 100%;
            width: 100%;
            box-shadow: var(--glow-purple);
        }

        .group-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-purple);
        }

        /* Challenge Creator */
        .challenge-creator {
            background: rgba(0, 136, 255, 0.1);
            border: 2px solid var(--primary-blue);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-width: 100%;
            width: 100%;
        }

        .challenge-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            margin: 8px 0;
            min-height: 80px;
            resize: vertical;
            font-size: 16px;
        }

        .challenge-type-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }

        /* End Game Screen */
        .end-game-screen {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid var(--primary-green);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            max-width: 100%;
            width: 100%;
            box-shadow: var(--glow-green);
        }

        .winner-crown {
            font-size: 4rem;
            color: #ffcc00;
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-width: 100%;
            width: 100%;
        }

        .achievement-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .achievement-card.earned {
            border: 2px solid var(--primary-yellow);
            background: rgba(255, 204, 0, 0.1);
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            color: var(--primary-yellow);
        }

        /* History Screen */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            margin: 15px 0;
            -webkit-overflow-scrolling: touch;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid var(--primary-blue);
            text-align: left;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 100%;
            width: 100%;
            margin: 20px 0;
        }

        .setting-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: left;
        }

        /* Buttons */
        .btn {
            padding: 14px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
            min-height: 44px;
            position: relative;
            overflow: hidden;
            margin: 4px;
            touch-action: manipulation;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.7s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: var(--primary-red);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 0, 51, 0.4);
        }

        /* Challenge Selector */
        .challenge-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 20px 0;
            max-width: 100%;
            width: 100%;
        }

        .btn-challenge {
            padding: 20px 12px;
            font-size: 1.1rem;
            border-radius: 12px;
            flex-direction: column;
            gap: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid;
            color: white;
            transition: all 0.3s ease;
            min-width: 0;
        }

        /* Animations */
        @keyframes logo-glow {
            0% { text-shadow: 0 0 20px rgba(255, 0, 51, 0.7); }
            50% { text-shadow: 0 0 30px rgba(170, 0, 255, 0.7), 0 0 40px rgba(170, 0, 255, 0.5); }
            100% { text-shadow: 0 0 20px rgba(0, 136, 255, 0.7); }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.05); opacity: 0.9; }
        }

        @keyframes current-player-glow {
            0% { box-shadow: 0 0 20px rgba(255, 0, 51, 0.5); }
            100% { box-shadow: 0 0 30px rgba(255, 0, 51, 0.8); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 8px;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
            min-width: 44px;
            min-height: 44px;
        }

        .nav-btn.active {
            opacity: 1;
            color: var(--primary-red);
        }

        .nav-btn i {
            font-size: 1.1rem;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-red);
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10001;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s ease;
            max-width: 90%;
            font-size: 0.9rem;
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            max-width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--primary-yellow), var(--primary-red));
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Team Display */
        .team-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .team {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            min-width: 150px;
        }

        .team-a {
            border: 2px solid var(--primary-blue);
        }

        .team-b {
            border: 2px solid var(--primary-red);
        }

        /* Sound Test Button */
        .sound-test {
            position: fixed;
            bottom: calc(var(--safe-bottom) + 70px);
            left: calc(var(--safe-left) + 10px);
            z-index: 1001;
            background: rgba(0, 136, 255, 0.9);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--primary-yellow);
            z-index: 10003;
            display: none;
            animation: popIn 0.3s ease;
            max-width: 300px;
            width: 90%;
            text-align: center;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Heartbeat Animation */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .heartbeat {
            animation: heartbeat 1s infinite;
        }

        /* Switch Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-green);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .logo {
                font-size: 2rem;
            }
            
            .tagline {
                font-size: 0.9rem;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
            }
            
            .challenge-selector {
                grid-template-columns: 1fr;
            }
            
            .game-header {
                flex-direction: column;
                gap: 8px;
                padding: 8px;
            }
            
            .stat-box {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            .btn {
                min-width: 110px;
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .panic-timer {
                font-size: 3rem;
            }
            
            .current-player-display {
                font-size: 1.3rem;
                padding: 10px 15px;
            }
            
            .emergency-stop {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
                top: calc(var(--safe-top) + 5px);
                right: calc(var(--safe-right) + 5px);
            }
            
            .volume-control {
                top: calc(var(--safe-top) + 5px);
                right: calc(var(--safe-right) + 60px);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .screen {
                padding: 10px;
            }
            
            .game-title h1 {
                font-size: 1rem;
                max-width: 120px;
            }
        }

        /* Prevent text merging */
        .btn span, .btn small, .mode-card h3, .mode-card p {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
            width: 100%;
        }

        .mode-card p, .mode-card small {
            font-size: 0.85rem;
            line-height: 1.3;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 3px;
        }

        /* Click feedback */
        .btn:active, .mode-card:active, .player-tag:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }
        
        /* Portrait-only adjustments */
        @media (orientation: portrait) {
            .screen {
                padding-bottom: 80px;
            }
        }
        
        /* Landscape prevention */
        @media (orientation: landscape) and (max-height: 600px) {
            .logo {
                font-size: 1.8rem;
            }
            
            .tagline {
                font-size: 0.8rem;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body class="theme-neon">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>Loading Ultimate Pass & Panic...</div>
    </div>

    <!-- Emergency Stop Button -->
    <button class="emergency-stop" id="emergencyStop" title="Emergency Stop">
        <i class="fas fa-stop"></i>
    </button>

    <!-- Offline Banner -->
    <div class="offline-banner" id="offlineBanner">
        <i class="fas fa-wifi-slash"></i> You're offline - Game still works!
    </div>

    <!-- Volume Control -->
    <div class="volume-control" id="volumeControl">
        <i class="fas fa-volume-up" id="volumeIcon"></i>
        <input type="range" min="0" max="1" step="0.1" value="0.8" class="volume-slider" id="volumeSlider">
    </div>

    <!-- Sound Test Button -->
    <button class="sound-test" id="soundTestBtn" title="Test Sound">
        <i class="fas fa-music"></i>
    </button>

    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <p>Install Ultimate Pass & Panic for the best experience!</p>
        <button id="installBtn">Install Now</button>
        <button onclick="hideInstallPrompt()" style="background: transparent; color: white; margin-left: 8px; font-size: 0.85rem;">Later</button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Background Animation -->
    <div class="background-animation"></div>
    <div class="particles" id="particles"></div>

    <!-- Game Header -->
    <div class="game-header">
        <div class="game-title">
            <h1>⚠️ PASS & PANIC</h1>
        </div>
        <div class="game-stats">
            <div class="stat-box" id="roundStat">Round: 1</div>
            <div class="stat-box" id="playersStat">Players: 0</div>
            <div class="stat-box" id="modeStat">Mode: Party</div>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="home" class="screen active">
        <div class="container">
            <div class="logo">PASS & PANIC</div>
            <p class="tagline">The ultimate party game for 2-30 players! Truth, dare, secret, and panic - all in one!</p>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="showScreen('modeSelection')">
                    <i class="fas fa-play"></i> START GAME
                </button>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn" onclick="showScreen('settings')" style="background: rgba(255,255,255,0.1); color: white; margin-left: 8px;">
                    <i class="fas fa-cog"></i> SETTINGS
                </button>
            </div>
            
            <div class="features" style="margin-top: 25px;">
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 15px;">
                    <div style="text-align: center; max-width: 120px;">
                        <div style="font-size: 1.5rem; color: var(--primary-red); margin-bottom: 8px;"><i class="fas fa-users"></i></div>
                        <h3 style="font-size: 0.9rem;">2-30 Players</h3>
                    </div>
                    <div style="text-align: center; max-width: 120px;">
                        <div style="font-size: 1.5rem; color: var(--primary-green); margin-bottom: 8px;"><i class="fas fa-gamepad"></i></div>
                        <h3 style="font-size: 0.9rem;">5 Modes</h3>
                    </div>
                    <div style="text-align: center; max-width: 120px;">
                        <div style="font-size: 1.5rem; color: var(--primary-blue); margin-bottom: 8px;"><i class="fas fa-volume-up"></i></div>
                        <h3 style="font-size: 0.9rem;">HD Sounds</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Selection Screen -->
    <div id="modeSelection" class="screen">
        <div class="container">
            <h1 style="font-size: 1.5rem; margin-bottom: 15px;">SELECT GAME MODE</h1>
            
            <div class="mode-selection">
                <div class="mode-card" onclick="selectGameMode('party')" id="modeParty">
                    <div class="mode-icon" style="color: var(--primary-blue);">
                        <i class="fas fa-glass-cheers"></i>
                    </div>
                    <h3>Party Mode</h3>
                    <div class="mode-tag">Default</div>
                    <p>Balanced mix for any gathering</p>
                </div>
                
                <div class="mode-card" onclick="selectGameMode('extreme')" id="modeExtreme">
                    <div class="mode-icon" style="color: var(--primary-red);">
                        <i class="fas fa-fire"></i>
                    </div>
                    <h3>Extreme Mode</h3>
                    <div class="mode-tag">Hardcore</div>
                    <p>More dares, shorter timer</p>
                </div>
                
                <div class="mode-card" onclick="selectGameMode('team')" id="modeTeam">
                    <div class="mode-icon" style="color: var(--primary-green);">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Team Mode</h3>
                    <div class="mode-tag">Cooperative</div>
                    <p>Split into teams</p>
                </div>
            </div>
            
            <div style="margin-top: 25px;">
                <button class="btn btn-primary" onclick="showScreen('setup')" id="continueToSetup">
                    <i class="fas fa-arrow-right"></i> CONTINUE
                </button>
                <button class="btn" onclick="showScreen('home')" style="background: rgba(255,255,255,0.1); color: white; margin-left: 8px;">
                    <i class="fas fa-arrow-left"></i> BACK
                </button>
            </div>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setup" class="screen">
        <div class="container">
            <h1 style="font-size: 1.5rem; margin-bottom: 15px;">GAME SETUP</h1>
            
            <div class="player-setup">
                <h2 style="margin-bottom: 15px;">
                    <i class="fas fa-users"></i> Add Players
                    <span style="font-size: 0.9rem; color: #aaa; margin-left: 8px;" id="playerCountDisplay">0/30</span>
                </h2>
                
                <div class="player-input">
                    <input type="text" id="playerNameInput" placeholder="Enter name or tap emoji" maxlength="15" aria-label="Player name">
                    <button onclick="addPlayer()" aria-label="Add player">ADD</button>
                </div>
                
                <p style="color: #aaa; margin-top: 8px; font-size: 0.85rem;">
                    Add 2+ players. Emoji names allowed!
                </p>
                
                <!-- Player List -->
                <div class="players-list" id="playersList">
                    <!-- Players will be added here -->
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="startGame()" id="startGameBtn" disabled>
                    <i class="fas fa-rocket"></i> START GAME
                </button>
                <button class="btn" onclick="showScreen('modeSelection')" style="background: rgba(255,255,255,0.1); color: white; margin-left: 8px;">
                    <i class="fas fa-arrow-left"></i> BACK
                </button>
            </div>
        </div>
    </div>

    <!-- Panic Screen -->
    <div id="panic" class="screen">
        <div class="container">
            <h1 style="font-size: 1.8rem; color: var(--primary-red); margin-bottom: 15px; animation: heartbeat 1s infinite;">PASS FAST!</h1>
            
            <div class="current-player-display" id="currentPlayerDisplay">
                <!-- Current player will be shown here -->
            </div>
            
            <div class="panic-timer" id="panicTimer">
                00:00
            </div>
            
            <div class="timer-pressure" id="timerPressure">
                PRESSURE: MEDIUM
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="panicProgress"></div>
            </div>
            
            <p style="font-size: 1rem; margin: 15px 0; color: #ff6666;">
                <i class="fas fa-bolt"></i> Pass the device quickly!
            </p>
            
            <div id="nextPlayerHint" style="margin-top: 15px; font-size: 1rem; color: #aaa;">
                Next: <span id="nextPlayerName">-</span>
            </div>
        </div>
    </div>

    <!-- Stop Screen -->
    <div id="stop" class="screen">
        <div class="container">
            <h1 style="font-size: 2rem; color: var(--primary-green); text-shadow: var(--glow-green); animation: blink 0.3s infinite alternate; margin-bottom: 15px;">STOP!</h1>
            
            <div class="caught-player" id="caughtPlayer" style="font-size: 1.3rem; margin: 15px 0; padding: 12px 20px; background: rgba(0, 255, 136, 0.2); border-radius: 15px; border: 2px solid var(--primary-green);">
                <!-- Caught player will be shown here -->
            </div>
            
            <p style="font-size: 1.1rem; margin-bottom: 15px;">Choose challenge:</p>
            
            <div class="challenge-selector">
                <button class="btn btn-challenge challenge-truth" onclick="chooseChallenge('truth')" style="border-color: var(--primary-blue);">
                    <i class="fas fa-comment-dots challenge-icon" style="font-size: 1.3rem;"></i>
                    <span>TRUTH</span>
                    <small>Reveal personal</small>
                </button>
                
                <button class="btn btn-challenge challenge-dare" onclick="chooseChallenge('dare')" style="border-color: var(--primary-red);">
                    <i class="fas fa-running challenge-icon" style="font-size: 1.3rem;"></i>
                    <span>DARE</span>
                    <small>Perform action</small>
                </button>
                
                <button class="btn btn-challenge challenge-secret" onclick="chooseChallenge('secret')" style="border-color: var(--primary-purple);">
                    <i class="fas fa-user-secret challenge-icon" style="font-size: 1.3rem;"></i>
                    <span>SECRET</span>
                    <small>Share fact</small>
                </button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result" class="screen">
        <div class="container">
            <div class="challenge-box" style="background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 15px; border: 2px solid var(--primary-blue); max-width: 100%; width: 100%; margin: 15px 0; box-shadow: var(--glow-blue);">
                <div class="challenge-text" id="challengeText" style="font-size: 1.3rem; line-height: 1.3; margin: 15px 0; min-height: 80px; display: flex; align-items: center; justify-content: center; padding: 8px;">
                    <!-- Challenge text will appear here -->
                </div>
                
                <div class="challenge-actions" style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="completeChallenge()" style="padding: 10px 15px;">
                        <i class="fas fa-check-circle"></i> DONE
                    </button>
                    <button class="btn" onclick="skipChallenge()" style="background: rgba(255, 204, 0, 0.2); color: white; border: 2px solid var(--primary-yellow); padding: 10px 15px;">
                        <i class="fas fa-redo"></i> SKIP
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <p style="font-size: 0.9rem; color: #aaa;">Player: <strong id="challengedPlayerName">-</strong></p>
            </div>
        </div>
    </div>

    <!-- End Game Screen -->
    <div id="endGame" class="screen">
        <div class="container">
            <div class="end-game-screen">
                <div class="winner-crown">
                    <i class="fas fa-crown"></i>
                </div>
                
                <h1 style="font-size: 1.8rem; color: var(--primary-yellow); margin-bottom: 8px;">
                    GAME OVER!
                </h1>
                
                <div style="margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; max-width: 100%;">
                    <h2 style="color: var(--primary-green); margin-bottom: 10px; font-size: 1rem;">
                        <i class="fas fa-trophy"></i> WINNER
                    </h2>
                    <div id="winnerDisplay" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-yellow);">
                        <!-- Winner will be displayed here -->
                    </div>
                </div>
                
                <div style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="showScreen('home')">
                        <i class="fas fa-home"></i> MAIN MENU
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings" class="screen">
        <div class="container">
            <h1 style="font-size: 1.5rem; margin-bottom: 15px;">SETTINGS</h1>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <h3>Sound Effects</h3>
                    <p>Enable game sounds</p>
                    <label class="switch">
                        <input type="checkbox" id="soundToggle" checked onchange="toggleSound()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <h3>Vibration</h3>
                    <p>Haptic feedback</p>
                    <label class="switch">
                        <input type="checkbox" id="vibrationToggle" checked onchange="toggleVibration()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Sound Volume -->
            <div style="margin: 25px 0; max-width: 100%; width: 100%;">
                <h3 style="margin-bottom: 10px;">Sound Volume</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-volume-mute"></i>
                    <input type="range" min="0" max="1" step="0.1" value="1" id="masterVolume" style="flex: 1;" oninput="changeMasterVolume(this.value)">
                    <i class="fas fa-volume-up"></i>
                </div>
                <p style="color: #666; font-size: 0.85rem; margin-top: 5px;">
                    Adjust master volume level
                </p>
            </div>
            
            <!-- Test Sound Buttons -->
            <div style="margin: 25px 0; max-width: 100%; width: 100%;">
                <h3 style="margin-bottom: 15px;">Test Sounds</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="playTestSound('button')" style="background: rgba(255, 0, 51, 0.2); color: white; border: 2px solid var(--primary-red); padding: 8px 12px;">
                        <i class="fas fa-mouse-pointer"></i> Click
                    </button>
                    <button class="btn" onclick="playTestSound('start')" style="background: rgba(0, 136, 255, 0.2); color: white; border: 2px solid var(--primary-blue); padding: 8px 12px;">
                        <i class="fas fa-play"></i> Start
                    </button>
                    <button class="btn" onclick="playTestSound('stop')" style="background: rgba(0, 255, 136, 0.2); color: white; border: 2px solid var(--primary-green); padding: 8px 12px;">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button class="btn" onclick="playTestSound('complete')" style="background: rgba(170, 0, 255, 0.2); color: white; border: 2px solid var(--primary-purple); padding: 8px 12px;">
                        <i class="fas fa-check"></i> Complete
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 25px;">
                <button class="btn btn-primary" onclick="showScreen('home')">
                    <i class="fas fa-arrow-left"></i> BACK TO HOME
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showScreen('home')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-btn" onclick="showScreen('modeSelection')">
            <i class="fas fa-gamepad"></i>
            <span>Game</span>
        </button>
        <button class="nav-btn" onclick="showScreen('settings')">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </button>
    </div>

    <script>
        // ============================================
        // ANDROID APK FIXES
        // ============================================
        
        // Fix for 100vh on mobile browsers
        function setVH() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Initial setup
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', setVH);
        
        // Prevent unwanted touch behaviors
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Prevent context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Prevent text selection
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Handle Android back button
        if (window.history && window.history.pushState) {
            window.history.pushState(null, null, window.location.href);
            window.addEventListener('popstate', function() {
                window.history.pushState(null, null, window.location.href);
                if (confirm('Exit the game?')) {
                    window.history.back();
                }
            });
        }
        
        // Fix for keyboard on Android
        let originalHeight = window.innerHeight;
        window.addEventListener('resize', function() {
            if (window.innerHeight < originalHeight) {
                // Keyboard is showing
                document.body.classList.add('keyboard-open');
            } else {
                // Keyboard is hiding
                document.body.classList.remove('keyboard-open');
            }
            originalHeight = window.innerHeight;
        });
        
        // Try to lock orientation to portrait
        function lockOrientation() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('portrait').catch(function(error) {
                    console.log('Orientation lock failed: ', error);
                });
            } else if (screen.lockOrientation) {
                screen.lockOrientation('portrait');
            }
        }
        
        // Lock orientation on load
        window.addEventListener('load', function() {
            setTimeout(lockOrientation, 500);
        });
        
        // Fix viewport for Android WebView
        if (/Android/.test(navigator.userAgent)) {
            const viewport = document.querySelector("meta[name=viewport]");
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no');
            }
        }
        
        // ============================================
        // ENHANCED SOUND MANAGER WITH HIGH VOLUME
        // ============================================
        class SoundManager {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.soundEnabled = true;
                this.masterVolume = 1.0; // Maximum volume (1.0 = 100%)
                
                // Initialize audio context on first user interaction
                this.initAudioContext();
            }
            
            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.connect(this.audioContext.destination);
                    this.masterGain.gain.value = this.masterVolume;
                    
                    // Resume on any user click (required for mobile)
                    document.addEventListener('click', () => {
                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                    }, { once: true });
                    
                    console.log('Audio context initialized with high volume');
                } catch (e) {
                    console.warn('Web Audio API not supported:', e);
                }
            }
            
            ensureAudioContext() {
                if (!this.audioContext) {
                    this.initAudioContext();
                }
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }
            
            playSound(soundName) {
                if (!this.soundEnabled || !this.audioContext) return;
                
                this.ensureAudioContext();
                
                try {
                    switch(soundName) {
                        case 'button':
                            this.playButtonSound();
                            break;
                        case 'start':
                            this.playStartSound();
                            break;
                        case 'stop':
                            this.playStopSound();
                            break;
                        case 'complete':
                            this.playCompleteSound();
                            break;
                        case 'tick':
                            this.playTickSound();
                            break;
                        case 'alarm':
                            this.playAlarmSound();
                            break;
                        case 'fail':
                            this.playFailSound();
                            break;
                        case 'victory':
                            this.playVictorySound();
                            break;
                        default:
                            this.playButtonSound();
                    }
                } catch (e) {
                    console.warn('Sound playback failed:', e);
                }
            }
            
            // HIGH VOLUME BUTTON CLICK SOUND (Loud and clear)
            playButtonSound() {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                // Higher frequency for better clarity
                oscillator.frequency.setValueAtTime(800, now);
                oscillator.type = 'sine';
                
                // MUCH LOUDER - increased from 0.1 to 0.5
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.5, now + 0.01); // Quick attack
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2); // Longer decay
                
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            }
            
            // START GAME SOUND (Loud and energetic)
            playStartSound() {
                const now = this.audioContext.currentTime;
                
                // Play multiple frequencies for richer sound
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.masterGain);
                        
                        const freq = 400 + (i * 200);
                        oscillator.frequency.setValueAtTime(freq, this.audioContext.currentTime);
                        oscillator.type = i === 0 ? 'sine' : 'triangle';
                        
                        // VERY LOUD
                        gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.6, this.audioContext.currentTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.4);
                        
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + 0.4);
                    }, i * 50);
                }
            }
            
            // STOP GAME SOUND (Loud and dramatic)
            playStopSound() {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                // Deep, powerful sound
                oscillator.frequency.setValueAtTime(200, now);
                oscillator.frequency.exponentialRampToValueAtTime(100, now + 0.5);
                oscillator.type = 'sawtooth'; // Richer sound
                
                // EXTRA LOUD
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.7, now + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                
                oscillator.start(now);
                oscillator.stop(now + 0.5);
            }
            
            // COMPLETE SOUND (Loud and positive)
            playCompleteSound() {
                const now = this.audioContext.currentTime;
                const notes = [523.25, 659.25, 783.99]; // C, E, G notes
                
                notes.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.masterGain);
                        
                        oscillator.frequency.setValueAtTime(freq, this.audioContext.currentTime);
                        oscillator.type = 'triangle'; // Pleasant sound
                        
                        // LOUD AND CLEAR
                        gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.5, this.audioContext.currentTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.3);
                        
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + 0.3);
                    }, index * 100);
                });
            }
            
            // TICK SOUND (For timer - loud and clear)
            playTickSound() {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                oscillator.frequency.setValueAtTime(1000, now); // High frequency for clarity
                oscillator.type = 'square'; // Sharp sound
                
                // LOUD TICK
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                
                oscillator.start(now);
                oscillator.stop(now + 0.05);
            }
            
            // ALARM SOUND (Very loud and urgent)
            playAlarmSound() {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(800, now);
                oscillator.frequency.exponentialRampToValueAtTime(1200, now + 0.2);
                oscillator.frequency.exponentialRampToValueAtTime(800, now + 0.4);
                
                // VERY LOUD ALARM
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.8, now + 0.05);
                gainNode.gain.setValueAtTime(0.8, now + 0.35);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                
                oscillator.start(now);
                oscillator.stop(now + 0.4);
            }
            
            // FAIL SOUND (Loud and negative)
            playFailSound() {
                const now = this.audioContext.currentTime;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                oscillator.frequency.setValueAtTime(300, now);
                oscillator.frequency.exponentialRampToValueAtTime(150, now + 0.3);
                oscillator.type = 'square';
                
                // LOUD FAIL SOUND
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.6, now + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
            }
            
            // VICTORY SOUND (Loud and celebratory)
            playVictorySound() {
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C, E, G, C notes
                
                notes.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.masterGain);
                        
                        oscillator.frequency.setValueAtTime(freq, this.audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        // VERY LOUD VICTORY
                        gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.7, this.audioContext.currentTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.3);
                        
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + 0.3);
                    }, index * 150);
                });
            }
            
            setMasterVolume(volume) {
                this.masterVolume = Math.max(0, Math.min(1, volume));
                if (this.masterGain) {
                    this.masterGain.gain.value = this.masterVolume;
                }
            }
            
            toggleSound(enabled) {
                this.soundEnabled = enabled;
            }
        }

        // ============================================
        // GAME STATE
        // ============================================
        const gameState = {
            players: [],
            currentPlayerIndex: 0,
            round: 1,
            gameMode: 'party',
            winCondition: 'points',
            scores: {},
            
            soundEnabled: true,
            vibrationEnabled: true,
            maxPlayers: 30,
            
            gameTimer: null,
            panicTimer: null,
            timeLimit: 0,
            timeElapsed: 0,
            panicInterval: null,
            
            currentChallenge: null,
            gameEnded: false
        };

        // Initialize Sound Manager
        const soundManager = new SoundManager();

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            emergencyStop: document.getElementById('emergencyStop'),
            offlineBanner: document.getElementById('offlineBanner'),
            installPrompt: document.getElementById('installPrompt'),
            installBtn: document.getElementById('installBtn'),
            toast: document.getElementById('toast'),
            
            roundStat: document.getElementById('roundStat'),
            playersStat: document.getElementById('playersStat'),
            modeStat: document.getElementById('modeStat'),
            
            playerNameInput: document.getElementById('playerNameInput'),
            playerCountDisplay: document.getElementById('playerCountDisplay'),
            playersList: document.getElementById('playersList'),
            startGameBtn: document.getElementById('startGameBtn'),
            
            currentPlayerDisplay: document.getElementById('currentPlayerDisplay'),
            panicTimer: document.getElementById('panicTimer'),
            timerPressure: document.getElementById('timerPressure'),
            panicProgress: document.getElementById('panicProgress'),
            nextPlayerName: document.getElementById('nextPlayerName'),
            
            caughtPlayer: document.getElementById('caughtPlayer'),
            
            challengeText: document.getElementById('challengeText'),
            challengedPlayerName: document.getElementById('challengedPlayerName'),
            
            winnerDisplay: document.getElementById('winnerDisplay'),
            
            soundToggle: document.getElementById('soundToggle'),
            vibrationToggle: document.getElementById('vibrationToggle'),
            masterVolume: document.getElementById('masterVolume'),
            
            modeParty: document.getElementById('modeParty'),
            modeExtreme: document.getElementById('modeExtreme'),
            modeTeam: document.getElementById('modeTeam'),
            continueToSetup: document.getElementById('continueToSetup'),
            
            particles: document.getElementById('particles')
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            // Ensure portrait mode
            lockOrientation();
            
            // Hide loading screen quickly
            setTimeout(() => {
                elements.loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    elements.loadingScreen.style.display = 'none';
                }, 300);
            }, 500);
            
            // Setup event listeners
            setupEventListeners();
            
            // Update online status
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Create particles
            createParticles();
            
            // Add test players
            setTimeout(() => {
                if (gameState.players.length === 0) {
                    ['Player 1 🎭', 'Player 2 🔥', 'Player 3 🚀', 'Player 4 🌟'].forEach(name => {
                        elements.playerNameInput.value = name;
                        addPlayer();
                    });
                    showToast('Test players added! Tap ADD to add more.');
                }
            }, 1000);
        });

        function setupEventListeners() {
            // Player input
            elements.playerNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });
            
            // Volume control
            const volumeSlider = document.getElementById('volumeSlider');
            if (volumeSlider) {
                volumeSlider.addEventListener('input', (e) => {
                    const volume = parseFloat(e.target.value);
                    soundManager.setMasterVolume(volume);
                    updateVolumeIcon(volume);
                });
            }
            
            // Master volume control
            if (elements.masterVolume) {
                elements.masterVolume.addEventListener('input', (e) => {
                    const volume = parseFloat(e.target.value);
                    soundManager.setMasterVolume(volume);
                });
            }
            
            // Sound test button
            const soundTestBtn = document.getElementById('soundTestBtn');
            if (soundTestBtn) {
                soundTestBtn.addEventListener('click', () => {
                    playTestSound('button');
                    showToast('Testing sound...');
                });
            }
            
            // Emergency stop
            elements.emergencyStop.addEventListener('click', emergencyStop);
            
            // Install prompt
            if (elements.installBtn) {
                elements.installBtn.addEventListener('click', async () => {
                    hideInstallPrompt();
                    showToast('Install feature coming soon!');
                });
            }
            
            // Click sounds for all buttons
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' || 
                    e.target.closest('button') || 
                    e.target.closest('.mode-card') ||
                    e.target.closest('.player-tag')) {
                    // Small delay to ensure sound plays
                    setTimeout(() => {
                        soundManager.playSound('button');
                    }, 10);
                }
            }, true);
            
            // Touch feedback for mobile
            document.addEventListener('touchstart', () => {
                // Ensure audio context is ready on first touch
                soundManager.ensureAudioContext();
            }, { once: true });
            
            // Handle orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    setVH();
                    // Force portrait on orientation change
                    lockOrientation();
                }, 300);
            });
        }

        // ============================================
        // SCREEN MANAGEMENT
        // ============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Update nav buttons
            updateNavButtons(screenId);
            
            // Screen-specific initialization
            switch(screenId) {
                case 'setup':
                    updatePlayerCountDisplay();
                    updatePlayersList();
                    break;
                case 'panic':
                    startPanicMode();
                    break;
            }
        }

        function updateNavButtons(screenId) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const navMap = {
                'home': 0,
                'modeSelection': 1,
                'settings': 2
            };
            
            if (navMap[screenId] !== undefined) {
                document.querySelectorAll('.nav-btn')[navMap[screenId]].classList.add('active');
            }
        }

        // ============================================
        // GAME MODE SELECTION
        // ============================================
        function selectGameMode(mode) {
            gameState.gameMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`)?.classList.add('selected');
            
            // Update mode stat
            elements.modeStat.textContent = `Mode: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
            
            elements.continueToSetup.disabled = false;
        }

        // ============================================
        // PLAYER MANAGEMENT
        // ============================================
        function addPlayer() {
            let name = elements.playerNameInput.value.trim();
            
            if (!name) {
                const emojis = ['🎭', '🔥', '🚀', '🌟', '🎯', '👑'];
                name = `Player ${gameState.players.length + 1} ${emojis[Math.floor(Math.random() * emojis.length)]}`;
            }
            
            if (gameState.players.length >= gameState.maxPlayers) {
                showToast(`Max ${gameState.maxPlayers} players!`);
                return;
            }
            
            if (gameState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast("Player exists!");
                return;
            }
            
            const player = {
                id: Date.now() + Math.random(),
                name: name,
                score: 0,
                avatarColor: getRandomColor()
            };
            
            gameState.players.push(player);
            updatePlayersList();
            
            elements.playerNameInput.value = '';
            elements.playerNameInput.focus();
            
            if (gameState.players.length >= 2) {
                elements.startGameBtn.disabled = false;
            }
            
            updatePlayerCountDisplay();
            
            // Play sound
            soundManager.playSound('button');
        }

        function updatePlayersList() {
            elements.playersList.innerHTML = '';
            
            gameState.players.forEach((player) => {
                const playerTag = document.createElement('div');
                playerTag.className = 'player-tag';
                playerTag.innerHTML = `
                    <div class="player-avatar" style="background: ${player.avatarColor}; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${player.name.charAt(0).toUpperCase()}
                    </div>
                    <span>${player.name}</span>
                    <button class="remove-player" onclick="removePlayer(${player.id})" aria-label="Remove">×</button>
                `;
                
                elements.playersList.appendChild(playerTag);
            });
        }

        function removePlayer(id) {
            const playerIndex = gameState.players.findIndex(p => p.id === id);
            if (playerIndex === -1) return;
            
            gameState.players.splice(playerIndex, 1);
            updatePlayersList();
            
            if (gameState.players.length < 2) {
                elements.startGameBtn.disabled = true;
            }
            
            updatePlayerCountDisplay();
            soundManager.playSound('button');
        }

        function updatePlayerCountDisplay() {
            elements.playerCountDisplay.textContent = `${gameState.players.length}/${gameState.maxPlayers}`;
            elements.playersStat.textContent = `Players: ${gameState.players.length}`;
        }

        function getRandomColor() {
            const colors = [
                '#ff0033', '#00ff88', '#0088ff', '#aa00ff', '#ffcc00',
                '#00ffff', '#ff00ff', '#ffff00', '#00ff00'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // ============================================
        // GAME START
        // ============================================
        function startGame() {
            if (gameState.players.length < 2) {
                showToast("Need 2+ players!");
                return;
            }
            
            gameState.round = 1;
            gameState.currentPlayerIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.gameEnded = false;
            
            // Initialize scores
            gameState.players.forEach(player => {
                gameState.scores[player.id] = 0;
            });
            
            updateStats();
            
            // Play loud start sound
            soundManager.playSound('start');
            
            // Vibrate if enabled
            if (gameState.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(100);
            }
            
            showScreen('panic');
        }

        // ============================================
        // PANIC MODE
        // ============================================
        function startPanicMode() {
            clearInterval(gameState.panicInterval);
            clearTimeout(gameState.gameTimer);
            
            // Timer settings
            let minTime = 4000;
            let maxTime = 8000;
            
            // Adjust for player count
            const playerCountBonus = (gameState.players.length - 2) * 150;
            minTime += playerCountBonus;
            maxTime += playerCountBonus;
            
            gameState.timeLimit = Math.random() * (maxTime - minTime) + minTime;
            gameState.timeElapsed = 0;
            
            // Update current player display
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            elements.currentPlayerDisplay.innerHTML = `
                <div class="player-avatar" style="background: ${currentPlayer.avatarColor}; display: inline-block; margin-right: 10px; width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${currentPlayer.name.charAt(0).toUpperCase()}
                </div>
                ${currentPlayer.name}'s TURN!
            `;
            
            // Update next player
            const nextPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            const nextPlayer = gameState.players[nextPlayerIndex];
            elements.nextPlayerName.textContent = nextPlayer.name;
            
            // Start timer
            const startTime = Date.now();
            
            gameState.panicInterval = setInterval(() => {
                gameState.timeElapsed = Date.now() - startTime;
                const timeLeft = Math.max(0, gameState.timeLimit - gameState.timeElapsed);
                
                // Update timer display
                const seconds = Math.floor(timeLeft / 1000);
                const milliseconds = Math.floor((timeLeft % 1000) / 10);
                elements.panicTimer.textContent = `${seconds.toString().padStart(2, '0')}:${milliseconds.toString().padStart(2, '0')}`;
                
                // Update progress bar
                const progress = (gameState.timeElapsed / gameState.timeLimit) * 100;
                elements.panicProgress.style.width = `${Math.min(100, progress)}%`;
                
                // Update pressure indicator
                updatePressureIndicator(progress);
                
                // Play warning sounds
                if (progress > 80 && gameState.timeElapsed % 500 < 50) {
                    soundManager.playSound('tick');
                }
                if (progress > 90 && gameState.timeElapsed % 300 < 50) {
                    soundManager.playSound('alarm');
                    if (gameState.vibrationEnabled && navigator.vibrate) {
                        navigator.vibrate(100);
                    }
                }
                
                // Time's up!
                if (gameState.timeElapsed >= gameState.timeLimit) {
                    clearInterval(gameState.panicInterval);
                    stopGame();
                }
            }, 50);
            
            // Random stop
            gameState.gameTimer = setTimeout(() => {
                clearInterval(gameState.panicInterval);
                stopGame();
            }, Math.random() * (gameState.timeLimit * 0.8) + (gameState.timeLimit * 0.2));
        }

        function updatePressureIndicator(progress) {
            let pressure, color;
            
            if (progress < 30) {
                pressure = "LOW";
                color = "var(--primary-green)";
            } else if (progress < 60) {
                pressure = "MEDIUM";
                color = "var(--primary-yellow)";
            } else if (progress < 80) {
                pressure = "HIGH";
                color = "var(--primary-red)";
            } else {
                pressure = "PANIC!";
                color = "#ff0000";
            }
            
            elements.timerPressure.textContent = `PRESSURE: ${pressure}`;
            elements.timerPressure.style.color = color;
        }

        function stopGame() {
            clearInterval(gameState.panicInterval);
            clearTimeout(gameState.gameTimer);
            
            // Play loud stop sound
            soundManager.playSound('stop');
            
            // Vibrate
            if (gameState.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            const caughtPlayer = gameState.players[gameState.currentPlayerIndex];
            elements.caughtPlayer.innerHTML = `
                <div class="player-avatar" style="background: ${caughtPlayer.avatarColor}; display: inline-block; margin-right: 15px; width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${caughtPlayer.name.charAt(0).toUpperCase()}
                </div>
                ${caughtPlayer.name} GOT CAUGHT!
            `;
            
            showScreen('stop');
        }

        // ============================================
        // CHALLENGE SYSTEM
        // ============================================
        const challenges = {
            truth: [
                "Who is your secret crush here?",
                "What's the most embarrassing thing you've done?",
                "Have you ever cheated on a test?",
                "What's your biggest insecurity?",
                "What's the worst lie you've told?"
            ],
            
            dare: [
                "Do 20 squats right now",
                "Let group choose a silly nickname for you",
                "Sing a song in an operatic voice",
                "Do your best celebrity impression",
                "Dance with no music for 30 seconds"
            ],
            
            secret: [
                "Reveal your most recent text message",
                "Show your browser history",
                "Tell everyone your phone wallpaper",
                "Share your celebrity crush",
                "Reveal your dream job"
            ]
        };

        function chooseChallenge(type) {
            // Play loud button sound
            soundManager.playSound('button');
            
            if (gameState.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            const challengeList = challenges[type];
            const challenge = challengeList[Math.floor(Math.random() * challengeList.length)];
            
            gameState.currentChallenge = {
                type: type,
                text: challenge,
                playerId: gameState.players[gameState.currentPlayerIndex].id
            };
            
            elements.challengeText.textContent = challenge;
            elements.challengedPlayerName.textContent = gameState.players[gameState.currentPlayerIndex].name;
            showScreen('result');
        }

        // ============================================
        // CHALLENGE COMPLETION
        // ============================================
        function completeChallenge() {
            // Play loud complete sound
            soundManager.playSound('complete');
            
            if (gameState.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(100);
            }
            
            const player = gameState.players[gameState.currentPlayerIndex];
            player.score += 10;
            
            if (checkWinCondition()) {
                endGame();
                return;
            }
            
            nextRound();
        }

        function skipChallenge() {
            if (confirm("Skip? Penalty applies!")) {
                const player = gameState.players[gameState.currentPlayerIndex];
                player.score -= 5;
                
                // Play fail sound
                soundManager.playSound('fail');
                
                if (gameState.vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate(200);
                }
                
                nextRound();
            }
        }

        // ============================================
        // GAME FLOW
        // ============================================
        function nextRound() {
            // Play button sound
            soundManager.playSound('button');
            
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            
            if (gameState.currentPlayerIndex === 0) {
                gameState.round++;
                
                if (gameState.winCondition === 'rounds' && gameState.round >= 10) {
                    endGame();
                    return;
                }
            }
            
            updateStats();
            showScreen('panic');
        }

        function checkWinCondition() {
            if (gameState.winCondition === 'points') {
                return gameState.players.some(player => player.score >= 100);
            }
            return false;
        }

        function endGame() {
            gameState.gameEnded = true;
            
            // Find winner
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);
            const winner = sortedPlayers[0].name;
            
            elements.winnerDisplay.textContent = winner;
            
            // Play victory sound
            soundManager.playSound('victory');
            
            // Vibrate for victory
            if (gameState.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 200]);
            }
            
            showScreen('endGame');
        }

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================
        function toggleSound() {
            const enabled = elements.soundToggle.checked;
            gameState.soundEnabled = enabled;
            soundManager.toggleSound(enabled);
            showToast(`Sound ${enabled ? 'ON' : 'OFF'}`);
        }

        function toggleVibration() {
            gameState.vibrationEnabled = elements.vibrationToggle.checked;
            showToast(`Vibration ${gameState.vibrationEnabled ? 'ON' : 'OFF'}`);
        }

        function changeMasterVolume(volume) {
            soundManager.setMasterVolume(volume);
            showToast(`Volume: ${Math.round(volume * 100)}%`);
        }

        function playTestSound(soundType) {
            soundManager.playSound(soundType);
            
            // Also vibrate for certain sounds
            if (gameState.vibrationEnabled && navigator.vibrate) {
                if (soundType === 'stop') {
                    navigator.vibrate(200);
                } else if (soundType === 'complete') {
                    navigator.vibrate(100);
                } else if (soundType === 'start') {
                    navigator.vibrate([100, 50, 100]);
                }
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function updateStats() {
            elements.roundStat.textContent = `Round: ${gameState.round}`;
            elements.playersStat.textContent = `Players: ${gameState.players.length}`;
        }

        function showToast(message, duration = 2000) {
            const toast = elements.toast;
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            elements.offlineBanner.style.display = isOnline ? 'none' : 'block';
        }

        function updateVolumeIcon(volume) {
            const icon = document.getElementById('volumeIcon');
            if (icon) {
                if (volume === 0) {
                    icon.className = 'fas fa-volume-mute';
                } else if (volume < 0.5) {
                    icon.className = 'fas fa-volume-down';
                } else {
                    icon.className = 'fas fa-volume-up';
                }
            }
        }

        function emergencyStop() {
            if (confirm('Stop game and return to home?')) {
                clearInterval(gameState.panicInterval);
                clearTimeout(gameState.gameTimer);
                
                gameState.currentPlayerIndex = 0;
                gameState.round = 1;
                gameState.gameEnded = true;
                
                // Play alarm sound
                soundManager.playSound('alarm');
                
                if (gameState.vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate(500);
                }
                
                showScreen('home');
                showToast('Game stopped');
            }
        }

        // ============================================
        // VISUAL EFFECTS
        // ============================================
        function createParticles() {
            for (let i = 0; i < 15; i++) {
                createParticle();
            }
        }

        function createParticle() {
            const particle = document.createElement('div');
            
            const size = Math.random() * 4 + 2;
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${x}vw`;
            particle.style.top = `${y}vh`;
            particle.style.position = 'absolute';
            particle.style.background = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.3)`;
            particle.style.borderRadius = '50%';
            particle.style.pointerEvents = 'none';
            
            elements.particles.appendChild(particle);
            
            // Simple floating animation
            const duration = Math.random() * 15 + 10;
            const delay = Math.random() * 5;
            
            setTimeout(() => {
                let start = null;
                function animate(time) {
                    if (!start) start = time;
                    const progress = (time - start) / (duration * 1000);
                    
                    if (progress < 1) {
                        particle.style.transform = `translateY(${progress * 100}px) rotate(${progress * 360}deg)`;
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                        createParticle();
                    }
                }
                requestAnimationFrame(animate);
            }, delay * 1000);
        }

        // ============================================
        // INSTALL PROMPT
        // ============================================
        function showInstallPrompt() {
            elements.installPrompt.style.display = 'block';
        }

        function hideInstallPrompt() {
            elements.installPrompt.style.display = 'none';
        }

        // ============================================
        // INITIAL SETUP COMPLETE
        // ============================================
        console.log('🎮 Pass & Panic loaded with HD sounds!');
        console.log('🔊 Sound volume is now MAXIMUM');
        console.log('📱 Optimized for Android APK in portrait mode');
    </script>
</body>
</html>
